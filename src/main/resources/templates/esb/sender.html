<!DOCTYPE html>
<html lang="en" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <title>Title</title>
  <link rel="stylesheet" href="/layui/css/layui.css" media="all" />
  <link rel="stylesheet" href="/css/custom.form.css" />
</head>

<body>
  <div class="panel panel-default data_form" hidden>
    <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">
      <ul class="layui-tab-title">
        <li class="layui-this"> 基础信息</li>
        <li>接口参数</li>
        <li>发送配置</li>
        <li>字段映射</li>
      </ul>
      <div class="layui-tab-content">
        <div class="panel-heading title"></div>
        <div class="layui-tab-item layui-show">
          <form class="layui-form layui-form-pane" style="width: 700px; margin-top: 10px">
            <input name="id" hidden />
            <div class="layui-form-item ">
              <label class="layui-form-label">接口代码</label>
              <div class="layui-input-block">
                <input type="text" name="ifCode" placeholder="请输入接口代码" autocomplete="off" class="layui-input"
                  lay-verify="required" lay-reqtext="接口代码是必填项，岂能为空？" />
              </div>
            </div>
            <div class="layui-form-item ">
              <label class="layui-form-label">接口名称</label>
              <div class="layui-input-block">
                <input type="text" name="ifName" placeholder="请输入接口名称" autocomplete="off" class="layui-input" />
              </div>
            </div>
            <div class="layui-form-item " hidden>
              <label class="layui-form-label">接口名称_zh</label>
              <div class="layui-input-block">
                <input type="text" name="ifNameZh" placeholder="请输入接口名称" autocomplete="off" class="layui-input" />
              </div>
            </div>
            <div class="layui-form-item ">
              <label class="layui-form-label">对方系统</label>
              <div class="layui-input-block">
                <input type="text" name="toSysName" placeholder="请输入对方系统名称" autocomplete="off" class="layui-input" />
              </div>
            </div>
            <div class="layui-form-item">
              <label class="layui-form-label">协议类型</label>
              <div class="layui-input-block">
                <input type="text" name="serviceTypeTitle" placeholder="请选择协议类型" autocomplete="off" class="layui-input"
                  style="background:#eeeeee!important">
                <input type="text" name="serviceType" hidden>
              </div>
            </div>
            <div class="layui-form-item">
              <label class="layui-form-label">服务实现类</label>
              <div class="layui-input-block">
                <input type="text" name="serviceClass" placeholder="请输入服务实现类" autocomplete="off" class="layui-input" />
              </div>
            </div>
            <div class="layui-form-item">
              <label class="layui-form-label">事务类型</label>
              <div class="layui-input-block">
                <input type="text" name="receiveTransactionTypeTitle" placeholder="请选择事务类型" autocomplete="off"
                  class="layui-input" style="background:#eeeeee!important">
                <input type="text" name="receiveTransactionType" hidden>
              </div>
            </div>
            <div class="layui-form-item">
              <label class="layui-form-label">接收删除值</label>
              <div class="layui-input-block">
                <input type="text" name="receiveDeleteFlag" placeholder="请输入接收删除值" autocomplete="off"
                  class="layui-input" />
              </div>
            </div>
            <div class="layui-form-item">
              <label class="layui-form-label">发送成功值</label>
              <div class="layui-input-block">
                <input type="text" name="sendSuccessFlag" placeholder="请输入发送成功值" autocomplete="off"
                  class="layui-input" />
              </div>
            </div>
            <div class="layui-form-item">
              <label class="layui-form-label">存储过程</label>
              <div class="layui-input-block">
                <input type="text" name="dbProc" placeholder="请输入存储过程" autocomplete="off" class="layui-input" />
              </div>
            </div>
            <div class="layui-form-item">
              <div class="layui-tree">
                <div id="permissionTree"></div>
              </div>
            </div>
            <div class="layui-form-item">
              <div class="layui-input-block">
                <button type="submit" class="layui-btn" lay-submit="" lay-filter="submit">
                  保存
                </button>
                <button class="layui-btn layui-btn-primary" id="btn_cancel">返回</button>
              </div>
            </div>
          </form>
        </div>
        <div class="layui-tab-item">
          <table class="layui-table" id="paramTable" lay-filter="paramTable"></table>
        </div>
        <div class="layui-tab-item">
          <form class="layui-form layui-form-pane" style="width: 700px; margin-top: 10px">
            <input name="id" hidden />
            <div class="layui-form-item ">
              <label class="layui-form-label">配置代码</label>
              <div class="layui-input-block">
                <input type="text" name="ifCode" placeholder="请输入接口代码" autocomplete="off" class="layui-input"
                  lay-verify="required" lay-reqtext="接口代码是必填项，岂能为空？" />
              </div>
            </div>
            <div class="layui-form-item layui-form-text">
              <label class="layui-form-label">数据查询SQL</label>
              <div class="layui-input-block">
                <textarea placeholder="请输入内容" class="layui-textarea"></textarea>
              </div>
            </div>
            <div class="layui-form-item layui-form-text">
              <label class="layui-form-label">发送成功SQL</label>
              <div class="layui-input-block">
                <textarea placeholder="请输入内容" class="layui-textarea"></textarea>
              </div>
            </div>
            <div class="layui-form-item layui-form-text">
              <label class="layui-form-label">发送失败SQL</label>
              <div class="layui-input-block">
                <textarea placeholder="请输入内容" class="layui-textarea"></textarea>
              </div>
            </div>
            <div class="layui-form-item">
              <div class="layui-input-block">
                <button type="submit" class="layui-btn" lay-submit="" lay-filter="submit">
                  保存
                </button>
                <button class="layui-btn layui-btn-primary" id="btn_cancel">返回</button>
              </div>
            </div>
          </form>
        </div>
        <div class="layui-tab-item">内容4</div>
      </div>
    </div>
  </div>
  <div class="data_table">
    <div id="searchParam" shiro:hasPermission="sys:role:list">
      <div class="layui-form-item">
        <div class="layui-input-inline">
          <input type="text" id="ifCode" class="layui-input" autocomplete="off" placeholder="请输入接口代码" />
        </div>
        <div class="layui-input-inline">
          <input type="text" id="ifName" class="layui-input" autocomplete="off" placeholder="请输入接口名称" />
        </div>
        <div class="layui-input-inline">
          <input type="text" id="toSysName" class="layui-input" autocomplete="off" placeholder="请输入对方系统代码" />
        </div>
        <div class="layui-input-inline layui-form">
          <select id="serviceType">
            <option value="">请选择协议类型</option>
            <option value="WebService">WebService</option>
            <option value="RESTFul">RESTFul</option>
          </select>
        </div>
        <div class="layui-input-inline">
          <button class="layui-btn" onclick="search()" id="search">查询</button>
        </div>
      </div>
    </div>
    <table class="layui-table" id="dataTable" lay-filter="dataTable"></table>
  </div>
  <div id="layerSelect" style="display: none"></div>
</body>
<script type="text/html" id="toolbar">
  <div class="layui-btn-container">
    <button class="layui-btn layui-btn-sm" lay-event="addNew" shiro:hasPermission="sys:role:add">
      添加
    </button>
  </div>
</script>
<script type="text/html" id="tool">
  <a class="layui-btn layui-btn-xs" lay-event="edit" shiro:hasPermission="sys:role:update">
    编辑
  </a>
  <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del" shiro:hasPermission="sys:role:deleted">
    删除
  </a>
</script>
<script type="text/html" id="barDemo">
  {{#if (d.sex == 1) { }}
  <span>男</span>
  {{# }else if(d.sex == 2){ }}
  <span>女</span>
  {{# } }}
</script>
<script src="/layui/layui.all.js"></script>
<script src="/js/core.util.js"></script>
<script src="/js/component.js"></script>

<script>
  var token = CoreUtil.getData('access_token');
  var tokenQuery = token.replace('#', '%23');
  var tableIns1;
  var tableParam = function (ifCode, toSysName) {
    table.render({
      elem: '#paramTable',
      contentType: 'application/json',
      headers: {
        authorization: token
      },
      page: true,
      url: '/esb/ifParams',
      method: 'POST',
      where: {
        ifCode: ifCode,
        toSysName: toSysName
      },
      parseData: function (res) {
        return {
          code: res.code,
          msg: res.msg,
          count: CoreUtil.isEmpty(res.data) ? 0 : res.data.total,
          data: CoreUtil.isEmpty(res.data) ? null : res.data.records,
        };
      },
      cols: [
        [{
            field: 'index',
            title: '序号',
            type: 'numbers'
          },
          {
            field: 'id',
            title: 'UUID',
            hide: true
          },
          {
            field: 'ifCode',
            title: '接口代码'
          },
          {
            field: 'toSysName',
            title: '对方系统'
          },
          {
            field: 'paramGroup',
            title: '参数组别'
          },
          {
            field: 'paramCode',
            title: '参数代码'
          },
          {
            field: 'paramName',
            title: '参数名称',
          },
          {
            field: 'paramValue',
            title: '参数值'
          },
          {
            field: 'editAble',
            title: '是否可编辑'
          },
          {
            field: 'creatTime',
            title: '创建时间'
          },
          {
            field: 'lastUpdateTime',
            title: '最后修改时间'
          },
          {
            toolbar: '#tool',
            title: '操作'
          },
        ],
      ],
      toolbar: '#toolbar',
    });
  }
  var table = layui.table;
  var form = layui.form;
  var layer = layui.layer;
  var $ = (jQuery = layui.jquery);
  var laydate = layui.laydate;
  var tree = layui.tree;
  var transfer = layui.transfer;
  var deptNo = null;
  var startTime = null;
  var endTime = null;
  layui.use(['table', 'layer', 'laydate', 'tree', 'transfer'], function () {
    tableIns1 = table.render({
      elem: '#dataTable',
      contentType: 'application/json',
      headers: {
        authorization: token
      },
      page: true,
      url: '/esb/senders',
      method: 'POST',
      parseData: function (res) {
        return {
          code: res.code,
          msg: res.msg,
          count: CoreUtil.isEmpty(res.data) ? 0 : res.data.total,
          data: CoreUtil.isEmpty(res.data) ? null : res.data.records,
        };
      },
      cols: [
        [{
            field: 'index',
            title: '序号',
            type: 'numbers'
          },
          {
            field: 'id',
            title: 'UUID',
            hide: true
          },
          {
            field: 'ifCode',
            title: '接口代码'
          },
          {
            field: 'ifName',
            title: '接口名称'
          },
          {
            field: 'toSysName',
            title: '对方系统'
          },
          {
            field: 'serviceType',
            title: '协议类型'
          },
          {
            field: 'serviceClass',
            title: '服务实现类'
          },
          {
            field: 'receiveTransactionType',
            title: '事务类型',
          },
          {
            field: 'receiveDeleteFlag',
            title: '接收删除值'
          },
          {
            field: 'sendSuccessFlag',
            title: '发送成功值'
          },
          {
            field: 'dbProc',
            title: '存储过程'
          },
          {
            toolbar: '#tool',
            title: '操作'
          },
        ],
      ],
      toolbar: '#toolbar',
    });
    table.on('toolbar(dataTable)', function (obj) {
      var checkStatus = table.checkStatus(obj.config.id);
      switch (obj.event) {
        case 'addNew':
          $('.title').html('新增发送接口');
          $('.data_table').hide();
          $('.data_form').show();
          $(".data_form input[name=id]").val("");
          $(".data_form input[name=ifCode]").val("");
          $(".data_form input[name=ifName]").val("");
          $(".data_form input[name=ifNameZh]").val("");
          $(".data_form input[name=toSysName]").val("");
          $(".data_form input[name=serviceTypeTitle]").val("");
          $(".data_form input[name=serviceType]").val("");
          $(".data_form input[name=serviceClass]").val("");
          $(".data_form input[name=receiveTransationTitle]").val("");
          $(".data_form input[name=receiveTransation]").val("");
          $(".data_form input[name=receiveDeleteFlag]").val("");
          $(".data_form input[name=sendSuccessFlag]").val("");
          $(".data_form input[name=dbProc]").val("");
          form.render(); //更新全部
          break;
      }
    });
    table.on('tool(dataTable)', function (obj) {
      var data = obj.data;
      switch (obj.event) {
        case 'del':
          var id = data.id;
          tipDialog(id, data.ifCode + '-' + data.ifName);
          break;
        case 'edit':
          $('.data_table').hide();
          $('.data_form').show();
          $('.title').html('编辑接口:' + data.ifCode);
          $(".data_form input[name=id]").val(data.id);
          $(".data_form input[name=ifCode]").val(data.ifCode);
          $(".data_form input[name=ifName]").val(data.ifName);
          $(".data_form input[name=ifNameZh]").val(data.ifNameZh);
          $(".data_form input[name=toSysName]").val(data.toSysName);
          $(".data_form input[name=serviceTypeTitle]").val(data.serviceType);
          $(".data_form input[name=serviceType]").val(data.serviceType);
          $(".data_form input[name=serviceClass]").val(data.serviceClass);
          $(".data_form input[name=receiveTransactionTypeTitle").val(data.receiveTransactionType);
          $(".data_form input[name=receiveTransactionType]").val(data.receiveTransactionType);
          $(".data_form input[name=receiveDeleteFlag]").val(data.receiveDeleteFlag);
          $(".data_form input[name=sendSuccessFlag]").val(data.sendSuccessFlag);
          $(".data_form input[name=dbProc]").val(data.dbProc);
          form.render();
          tableParam(data.ifCode, data.toSysName);
          break;
      }
    });
    //表单事件 返回
    $('#btn_cancel').click(function () {
      $('.data_table').show();
      $('.data_form').hide();
      return false;
    });
    //表单事件 提交
    form.on('submit(submit)', function (data) {
      if (data.field.id === undefined || data.field.id === null || data.field.id === '') {
        CoreUtil.sendPost('/esb/sender', data.field, function (res) {
          $('.data_table').show();
          $('.data_form').hide();
          search();
        });
      } else {
        CoreUtil.sendPut('/esb/sender', data.field, function (res) {
          $('.data_table').show();
          $('.data_form').hide();
          search();
        });
      }
      return false;
    });
    //表单组件事件监听
    $('.data_form input[name=serviceTypeTitle]').click(function () {
      selectTree([{
        id: 0,
        title: "WebService",
        field: "WebService"
      }, {
        id: 1,
        title: "RESTFul",
        field: "RESTFul"
      }]);
      selectLayer("请选择服务类型", 'data_form', 'serviceTypeTitle', 'serviceType');
    });
    $('.data_form input[name=receiveTransactionTypeTitle]').click(function () {
      selectTree([{
        id: 0,
        title: "每条数据",
        field: "EachData"
      }, {
        id: 1,
        title: "整笔数据",
        field: "WholeData"
      }]);
      selectLayer("请选择事务类型", 'data_form', 'receiveTransactionTypeTitle', 'receiveTransactionType');
    });
  });
  //执行查询
  function search() {
    tableIns1.reload({
      where: {
        //设定异步数据接口的额外参数，任意设
        ifCode: $('#ifCode').val(),
        ifName: $('#ifCode').val(),
        toSysName: $('#toSysName').val(),
        serviceType: $('#serviceType').val(),
      },
      page: {
        curr: 1, //重新从第 1 页开始
      },
    });
  }
</script>

</html>